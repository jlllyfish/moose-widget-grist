<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ¦Œ Moose â€“ GÃ©nÃ©rateur d'URL Grist/DN</title>

  <!-- DSFR -->

  <!-- Grist Plugin API -->
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>

  <style>
    /* â”€â”€ Reset â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; }

    /* â”€â”€ Base â”€â”€ */
    html, body {
      margin: 0;
      padding: 0;
      background: #f6f6f6;
      font-family: Marianne, Arial, sans-serif;
      font-size: 15px;
      line-height: 1.5;
    }

    .widget-container {
      max-width: 720px;
      margin: 0 auto;
      padding: 1.25rem 1rem 2rem;
    }

    /* â”€â”€ Breakpoints via ResizeObserver â”€â”€ */
    /* narrow  : < 380px  â†’ .w-narrow  */
    /* medium  : 380â€“560px â†’ .w-medium  */
    /* large   : > 560px  â†’ (dÃ©faut)   */

    .w-narrow { font-size: 13px; }
    .w-medium { font-size: 14px; }

    .w-narrow .widget-container { padding: 0.6rem 0.6rem 1.5rem; }
    .w-medium .widget-container { padding: 0.875rem 0.75rem 2rem; }

    /* â”€â”€ Header â”€â”€ */
    .widget-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.1rem;
      padding-bottom: 0.6rem;
      border-bottom: 2px solid #000091;
    }
    .widget-header svg { flex-shrink: 0; }
    .w-narrow .widget-header svg { width: 30px; height: auto; }
    .w-medium .widget-header svg { width: 38px; height: auto; }

    .widget-header h1 {
      font-size: 1.2rem;
      font-weight: 700;
      margin: 0;
      color: #000091;
      line-height: 1.2;
    }
    .w-narrow .widget-header h1 { font-size: 0.95rem; }
    .w-medium .widget-header h1 { font-size: 1.05rem; }

    /* â”€â”€ Statut connexion â”€â”€ */
    #grist-status {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.85rem;
      padding: 0.35rem 0.75rem;
      border-radius: 1rem;
      margin-bottom: 0.875rem;
      font-weight: 500;
    }
    .w-narrow #grist-status { font-size: 0.75rem; padding: 0.3rem 0.6rem; }
    #grist-status.status-ok      { background: #dffee7; color: #18753c; }
    #grist-status.status-loading { background: #e8edff; color: #000091; }
    #grist-status.status-error   { background: #ffe9e9; color: #ce0500; }
    #grist-status .dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: currentColor;
      flex-shrink: 0;
    }
    #grist-status.status-loading .dot { animation: pulse 1.2s ease-in-out infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

    /* â”€â”€ Formulaire â”€â”€ */
    .fr-label {
      display: block;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .w-narrow .fr-label { font-size: 0.82rem; }

    .fr-hint-text {
      display: block;
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.15rem;
      margin-bottom: 0.2rem;
    }
    .w-narrow .fr-hint-text { font-size: 0.72rem; }

    .fr-select-group { margin-bottom: 1rem; }
    .w-narrow .fr-select-group { margin-bottom: 0.75rem; }

    .fr-select {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #929292;
      border-radius: 0.25rem;
      background: white;
      font-size: 0.9rem;
      font-family: inherit;
      margin-top: 0.2rem;
      appearance: auto;
    }
    .w-narrow .fr-select { padding: 0.4rem 0.6rem; font-size: 0.82rem; }
    .fr-select:disabled { background: #e5e5e5; color: #929292; cursor: not-allowed; }
    .fr-select:focus { outline: 2px solid #0a76f6; outline-offset: 2px; }

    /* â”€â”€ Boutons â”€â”€ */
    .fr-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.25rem;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: background 0.15s, color 0.15s;
    }
    .w-narrow .fr-btn { padding: 0.4rem 0.75rem; font-size: 0.82rem; }
    .fr-btn:not(.fr-btn--secondary) { background: #000091; color: white; }
    .fr-btn:not(.fr-btn--secondary):hover { background: #1212ff; }
    .fr-btn--secondary { background: transparent; color: #000091; border: 1px solid currentColor; }
    .fr-btn--secondary:hover { background: #f0f0ff; }
    .fr-btn:disabled { background: #e5e5e5; color: #929292; border-color: transparent; cursor: not-allowed; }
    .fr-btn--sm { padding: 0.3rem 0.65rem; font-size: 0.82rem; }
    .fr-btn--loading { pointer-events: none; opacity: 0.7; }

    .btns-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.875rem;
    }
    .w-narrow .btns-row { flex-direction: column; }
    .w-narrow .btns-row .fr-btn { width: 100%; }

    /* â”€â”€ Alerte â”€â”€ */
    .alert {
      padding: 0.75rem 1rem;
      border-radius: 0.25rem;
      font-size: 0.9rem;
      margin-bottom: 0.875rem;
      line-height: 1.5;
    }
    .w-narrow .alert { padding: 0.6rem 0.75rem; font-size: 0.8rem; }
    .alert--info    { background: #e8edff; color: #000091; border-left: 3px solid #000091; }
    .alert--error   { background: #ffe9e9; color: #ce0500; border-left: 3px solid #ce0500; }
    .alert--success { background: #dffee7; color: #18753c; border-left: 3px solid #18753c; }
    .alert a { text-decoration: none !important; color: #000091; font-weight: 600; }
    .alert a:hover { opacity: 0.8; }

    /* â”€â”€ RÃ©sultat â”€â”€ */
    #result { margin-top: 1rem; }
    .result-card { border: 1px solid #ddd; border-radius: 0.375rem; overflow: hidden; }
    .result-card-header {
      background: #000091; color: white;
      padding: 0.55rem 1rem;
      font-weight: 700;
      font-size: 0.9rem;
    }
    .w-narrow .result-card-header { font-size: 0.82rem; padding: 0.45rem 0.75rem; }
    .result-card-body { padding: 1rem; background: white; }
    .w-narrow .result-card-body { padding: 0.75rem; }

    .url-block {
      background: #f4f4f4;
      border-left: 3px solid #000091;
      padding: 0.6rem 0.875rem;
      border-radius: 0 0.25rem 0.25rem 0;
      margin-bottom: 0.875rem;
      word-break: break-all;
      font-family: 'Courier New', monospace;
      font-size: 0.75rem;
      line-height: 1.5;
    }
    .w-narrow .url-block { font-size: 0.68rem; padding: 0.5rem 0.6rem; }

    .meta-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 0.2rem 0.6rem;
      font-size: 0.82rem;
      margin-bottom: 0.875rem;
    }
    .meta-grid dt { font-weight: 600; color: #555; white-space: nowrap; }
    .meta-grid dd { margin: 0; color: #333; word-break: break-word; }
    .w-narrow .meta-grid { grid-template-columns: 1fr; }
    .w-narrow .meta-grid dt { margin-top: 0.35rem; color: #444; }

    /* â”€â”€ AccordÃ©on â”€â”€ */
    .accordion { border: 1px solid #ddd; border-radius: 0.25rem; margin-top: 0.875rem; }
    .accordion__btn {
      width: 100%;
      padding: 0.65rem 0.875rem;
      background: #f8f8f8;
      border: none;
      text-align: left;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: inherit;
      gap: 0.5rem;
    }
    .w-narrow .accordion__btn { font-size: 0.78rem; padding: 0.55rem 0.75rem; }
    .accordion__btn:hover { background: #ebebeb; }
    .accordion__btn::after { content: "â–¾"; flex-shrink: 0; transition: transform 0.2s; }
    .accordion__btn[aria-expanded="true"]::after { transform: rotate(180deg); }
    .accordion__body { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .accordion__body.open { max-height: 400px; overflow-y: auto; }
    .accordion__body pre {
      margin: 0;
      padding: 0.65rem 0.875rem;
      font-size: 0.75rem;
      font-family: 'Courier New', monospace;
      line-height: 1.4;
      white-space: pre-wrap;
      word-break: break-all;
      background: #f4f4f4;
      border-top: 1px solid #ddd;
    }
    .w-narrow .accordion__body pre { font-size: 0.68rem; }

    /* â”€â”€ Toast â”€â”€ */
    #toast {
      position: fixed;
      bottom: 1rem; right: 1rem;
      padding: 0.55rem 0.875rem;
      border-radius: 0.25rem;
      font-size: 0.85rem;
      font-weight: 600;
      background: #18753c;
      color: white;
      opacity: 0;
      transform: translateY(0.5rem);
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: none;
      z-index: 9999;
    }
    #toast.show { opacity: 1; transform: translateY(0); }

    /* â”€â”€ Modale â”€â”€ */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal-overlay.open { display: flex; }
    .modal-box {
      background: white;
      border-radius: 0.375rem;
      padding: 1.25rem;
      width: 100%;
      max-width: 380px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.18);
    }
    .modal-box h2 { font-size: 1rem; margin: 0 0 0.75rem; }
    .modal-box input {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #929292;
      border-radius: 0.25rem;
      font-family: inherit;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    .modal-box input:focus { outline: 2px solid #0a76f6; outline-offset: 2px; }
    .modal-btns { display: flex; justify-content: flex-end; gap: 0.5rem; }
  </style>
</head>
<body>

<div class="widget-container">

  <!-- En-tÃªte -->
  <div class="widget-header">
    <svg width="48" height="38" viewBox="0 0 27.74049 21.695971" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" style="flex-shrink:0">
      <g transform="translate(-75.083443,-40.067527)">
        <path fill="#000091" d="m 92.723186,60.206519 c -0.0895,-0.85628 -0.35314,-2.11772 -0.58587,-2.80321 -0.23273,-0.68548 -0.38371,-1.28577 -0.33551,-1.33397 0.0482,-0.0482 0.80089,0.15664 1.67266,0.4552 2.3434,0.80256 6.29071,0.79991 7.593244,-0.005 2.26575,-1.40031 2.35585,-4.60329 0.17328,-6.15994 -0.87771,-0.626 -0.98579,-0.63576 -7.933004,-0.71633 -6.227857,-0.0722 -7.093091,-0.0318 -7.474478,0.34963 -0.371861,0.37186 -0.431316,1.21284 -0.431316,6.10096 v 5.66964 h 3.741859 3.741855 z m -3.883228,-7.30885 c -0.177082,-0.21337 -0.252852,-0.56806 -0.168378,-0.78819 0.202301,-0.52719 1.128072,-0.5145 1.332513,0.0183 0.223297,0.5819 0.22053,0.58913 -0.340785,0.88953 -0.371633,0.19889 -0.584704,0.16794 -0.82335,-0.11961 z m 0.720763,-4.15177 c 0.468181,-0.13584 1.152795,-0.60536 1.521355,-1.04338 0.56885,-0.67603 0.67012,-1.06007 0.67012,-2.54119 0,-1.25226 -0.12361,-1.88139 -0.43789,-2.22866 -0.896,-0.99007 -2.737114,-0.30102 -2.737114,1.02439 0,0.77433 -1.102322,1.93134 -1.840056,1.93134 -0.973035,0 -1.599527,-0.92515 -1.599527,-2.36205 0,-1.09328 -0.112523,-1.39222 -0.69714,-1.85208 -0.856636,-0.67383 -1.192598,-0.68466 -1.960115,-0.0632 -0.45817,0.371 -0.628638,0.84007 -0.724232,1.99281 -0.130125,1.56914 -0.663849,2.28448 -1.704468,2.28448 -1.022508,0 -1.528629,-0.94413 -1.528629,-2.85155 0,-2.22297 -0.432262,-2.96928 -1.719791,-2.96928 -1.414704,0 -1.719792,0.68408 -1.719792,3.8562 0,2.3527 0.07385,2.78996 0.604474,3.57915 0.34206,0.50874 1.002512,1.03847 1.521355,1.22025 1.096935,0.38431 11.042196,0.40261 12.35145,0.0227 z"/>
      </g>
    </svg>
    <h1>Moose â€“ GÃ©nÃ©rateur d'URL Grist/DN</h1>
  </div>

  <!-- Statut connexion Grist -->
  <div id="grist-status" class="status-loading">
    <span class="dot"></span>
    <span id="grist-status-text">Connexion Ã  Gristâ€¦</span>
  </div>

  <!-- Info -->
  <div class="alert alert--info">
    <strong>Information</strong><br/><span style="display:block;margin-top:0.25rem">Cet outil vous permet de gÃ©nÃ©rer des URLs d'API Grist avec filtres dynamiques pour intÃ©grer vos donnÃ©es dans le <a href="https://doc.demarches-simplifiees.fr/tutoriels/champ-referentiel-avance-a-configurer" target="_blank" rel="noopener noreferrer" >champ rÃ©fÃ©rentiel avancÃ©</a> de DÃ©marche NumÃ©rique.</span>
  </div>

  <!-- Formulaire -->
  <form id="urlForm">

    <!-- SÃ©lection table -->
    <div class="fr-select-group">
      <label class="fr-label" for="table_name">Table</label>
      <div class="fr-hint-text">Tables du document courant</div>
      <select class="fr-select" id="table_name" name="table_name" required disabled>
        <option value="">-- Chargementâ€¦ --</option>
      </select>
    </div>

    <!-- SÃ©lection colonne -->
    <div class="fr-select-group">
      <label class="fr-label" for="column_name">Colonne de filtre</label>
      <div class="fr-hint-text">Colonne sur laquelle appliquer le filtre <code>{id}</code></div>
      <select class="fr-select" id="column_name" name="column_name" required disabled>
        <option value="">-- Choisir d'abord une table --</option>
      </select>
    </div>

    <div class="btns-row">
      <button type="submit" class="fr-btn" id="generateBtn" disabled>
        GÃ©nÃ©rer l'URL
      </button>
    </div>

  </form>

  <!-- Zone rÃ©sultat -->
  <div id="result"></div>

</div>

<!-- Toast copie -->
<div id="toast">âœ“ URL copiÃ©e !</div>

<!-- Modale valeur de test -->
<div class="modal-overlay" id="testModal">
  <div class="modal-box">
    <h2>Valeur de test pour <code>{id}</code></h2>
    <input type="text" id="testValueInput" placeholder="Ex : LPA, 75, mon-codeâ€¦" />
    <div class="modal-btns">
      <button class="fr-btn fr-btn--secondary fr-btn--sm" id="cancelTestBtn">Annuler</button>
      <button class="fr-btn fr-btn--sm" id="confirmTestBtn">Tester</button>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RESPONSIVE via ResizeObserver
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  const body = document.body;
  const observer = new ResizeObserver(entries => {
    const width = entries[0].contentRect.width;
    body.classList.remove('w-narrow', 'w-medium');
    if (width < 380) body.classList.add('w-narrow');
    else if (width < 560) body.classList.add('w-medium');
    console.log('[Moose] ResizeObserver width:', width, 'â†’ classes:', body.className);
  });
  observer.observe(body);
  console.log('[Moose] ResizeObserver initialisÃ©');
})();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GRIST_BASE_URL = "https://grist.numerique.gouv.fr";
const EXCLUDED_TABLES = new Set([
  'GristDocTour', 'GristHidden_import',
  '_grist_Tables', '_grist_Tables_column',
  '_grist_Views', '_grist_Views_section',
  '_grist_Views_section_field', '_grist_TabBar',
  '_grist_Pages', '_grist_Attachments',
  '_grist_Cells', '_grist_ACLResources',
  '_grist_ACLRules', '_grist_ACLMemberships'
]);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ã‰TAT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let docId = null;
let currentUrl = null;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ã‰LÃ‰MENTS DOM
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $ = id => document.getElementById(id);
const tableSelect  = $('table_name');
const columnSelect = $('column_name');
const generateBtn  = $('generateBtn');
const resultDiv    = $('result');
const toast        = $('toast');
const testModal    = $('testModal');
const testInput    = $('testValueInput');

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATUT CONNEXION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(state, text) {
  const el = $('grist-status');
  el.className = `status-${state}`;
  $('grist-status-text').textContent = text;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UTILITAIRES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg = 'âœ“ URL copiÃ©e !') {
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

function setLoading(btn, loading, label) {
  if (loading) {
    btn.dataset.orig = btn.textContent;
    btn.textContent = 'Chargementâ€¦';
    btn.classList.add('fr-btn--loading');
    btn.disabled = true;
  } else {
    btn.textContent = btn.dataset.orig || label || btn.textContent;
    btn.classList.remove('fr-btn--loading');
    btn.disabled = false;
    delete btn.dataset.orig;
  }
}

function generateFilterUrl(dId, table, column) {
  const filterJson = `{"${column}":["PLACEHOLDER_ID"]}`;
  let encoded = encodeURIComponent(filterJson);
  encoded = encoded.replace('PLACEHOLDER_ID', '{id}');
  return `${GRIST_BASE_URL}/api/docs/${dId}/tables/${table}/records?filter=${encoded}`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ACCESS TOKEN â†’ appels REST depuis le widget
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function getToken(readOnly = true) {
  const info = await grist.docApi.getAccessToken({ readOnly });
  return info; // { token, baseUrl, ttlMsecs }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CHARGEMENT DES TABLES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTables() {
  setStatus('loading', 'Chargement des tablesâ€¦');
  tableSelect.disabled = true;
  tableSelect.innerHTML = '<option value="">-- Chargementâ€¦ --</option>';
  columnSelect.innerHTML = '<option value="">-- Choisir d\'abord une table --</option>';
  columnSelect.disabled = true;
  generateBtn.disabled = true;
  resultDiv.innerHTML = '';

  try {
    // listTables() disponible nativement sans token
    const tables = await grist.docApi.listTables();
    const filtered = tables.filter(t => !t.startsWith('_grist_') && !EXCLUDED_TABLES.has(t));

    if (filtered.length === 0) {
      tableSelect.innerHTML = '<option value="">-- Aucune table disponible --</option>';
      setStatus('error', 'Aucune table accessible (vÃ©rifiez le niveau d\'accÃ¨s)');
      return;
    }

    tableSelect.innerHTML = '<option value="">-- Choisir une table --</option>';
    filtered.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t;
      tableSelect.appendChild(opt);
    });
    tableSelect.disabled = false;
    setStatus('ok', `ConnectÃ© Â· ${filtered.length} table${filtered.length > 1 ? 's' : ''} disponible${filtered.length > 1 ? 's' : ''}`);

  } catch (err) {
    console.error('[Moose] loadTables:', err);
    tableSelect.innerHTML = '<option value="">-- Erreur de chargement --</option>';
    setStatus('error', `Erreur : ${err.message}`);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CHARGEMENT DES COLONNES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadColumns(tableName) {
  columnSelect.innerHTML = '<option value="">-- Chargementâ€¦ --</option>';
  columnSelect.disabled = true;
  generateBtn.disabled = true;
  resultDiv.innerHTML = '';

  try {
    // grist.docApi.fetchTable : pas de CORS, passe par le bridge Grist
    const tableData = await grist.docApi.fetchTable(tableName);
    const EXCLUDED_COLS = new Set(['id', 'manualSort']);
    const cols = Object.keys(tableData).filter(k => !EXCLUDED_COLS.has(k) && !k.startsWith('gristHelper_'));
    if (cols.length === 0) {
      columnSelect.innerHTML = '<option value="">-- Aucune colonne --</option>';
      return;
    }

    columnSelect.innerHTML = '<option value="">-- Choisir une colonne --</option>';
    cols.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      columnSelect.appendChild(opt);
    });
    columnSelect.disabled = false;

  } catch (err) {
    console.error('[Moose] loadColumns:', err);
    columnSelect.innerHTML = `<option value="">-- Erreur : ${err.message} --</option>`;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AFFICHAGE RÃ‰SULTAT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showResult(url, table, column) {
  currentUrl = url;
  resultDiv.innerHTML = `
    <div class="result-card">
      <div class="result-card-header">
        âœ… URL gÃ©nÃ©rÃ©e
      </div>
      <div class="result-card-body">
        <div class="url-block" id="url-display">${url}</div>
        <dl class="meta-grid">
          <dt>Document ID :</dt><dd id="meta-docid">${docId}</dd>
          <dt>Table :</dt><dd>${table}</dd>
          <dt>Colonne :</dt><dd>${column}</dd>
          <dt>Placeholder :</dt><dd><code>{id}</code> sera remplacÃ© par la valeur filtrÃ©e</dd>
        </dl>
        <div class="btns-row">
          <button class="fr-btn fr-btn--secondary fr-btn--sm" id="copyBtn">
            ğŸ“‹ Copier l'URL
          </button>
          <button class="fr-btn fr-btn--sm" id="testBtn">
            ğŸ§ª Tester l'URL
          </button>
        </div>
        <div id="test-result-zone"></div>
      </div>
    </div>
  `;

  $('copyBtn').addEventListener('click', () => {
    navigator.clipboard.writeText(url)
      .then(() => showToast('âœ“ URL copiÃ©e !'))
      .catch(() => {
        // fallback
        const ta = document.createElement('textarea');
        ta.value = url;
        ta.style.cssText = 'position:fixed;opacity:0';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        showToast('âœ“ URL copiÃ©e !');
      });
  });

  $('testBtn').addEventListener('click', openTestModal);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MODALE TEST + APPEL API
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openTestModal() {
  testInput.value = '';
  testModal.classList.add('open');
  setTimeout(() => testInput.focus(), 50);
}

function closeTestModal() {
  testModal.classList.remove('open');
}

$('cancelTestBtn').addEventListener('click', closeTestModal);

testModal.addEventListener('click', e => {
  if (e.target === testModal) closeTestModal();
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape' && testModal.classList.contains('open')) closeTestModal();
  if (e.key === 'Enter' && testModal.classList.contains('open')) runTest();
});

$('confirmTestBtn').addEventListener('click', runTest);

async function runTest() {
  const val = testInput.value.trim();
  if (!val) return;
  closeTestModal();

  const zone = $('test-result-zone');
  if (!zone) return;

  const testUrl = currentUrl.replace('{id}', encodeURIComponent(val));

  zone.innerHTML = `
    <div class="accordion" id="test-accordion">
      <button class="accordion__btn" aria-expanded="true" id="accordion-toggle">
        ğŸ§ª Test avec <code>"${val}"</code> â€“ chargementâ€¦
      </button>
      <div class="accordion__body open" id="accordion-body">
        <pre id="test-json">Chargementâ€¦</pre>
      </div>
    </div>
  `;

  // Toggle accordÃ©on
  $('accordion-toggle').addEventListener('click', function() {
    const expanded = this.getAttribute('aria-expanded') === 'true';
    this.setAttribute('aria-expanded', String(!expanded));
    $('accordion-body').classList.toggle('open', !expanded);
  });

  try {
    // fetchTable via bridge Grist (pas de CORS)
    const table = tableSelect.value;
    const column = columnSelect.value;
    const tableData = await grist.docApi.fetchTable(table);
    const ids = tableData.id || [];
    const colData = tableData[column] || [];

    const matchingRecords = ids.reduce((acc, rowId, i) => {
      if (String(colData[i] ?? '') === val) {
        const fields = {};
        Object.keys(tableData).forEach(k => { fields[k] = tableData[k][i]; });
        acc.push({ id: rowId, fields });
      }
      return acc;
    }, []);

    const count = matchingRecords.length;
    const data = { records: matchingRecords };

    $('accordion-toggle').innerHTML = `ğŸ§ª Test avec <code>"${val}"</code> â€“ ${count} enregistrement${count > 1 ? 's' : ''} trouvÃ©${count > 1 ? 's' : ''}`;
    $('test-json').textContent = JSON.stringify(data, null, 2);

  } catch (err) {
    $('accordion-toggle').innerHTML = `âŒ Erreur lors du test avec <code>"${val}"</code>`;
    $('test-json').textContent = `Erreur : ${err.message}\n\nURL testÃ©e :\n${testUrl}`;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Ã‰VÃ‰NEMENTS FORMULAIRE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
tableSelect.addEventListener('change', function() {
  if (this.value) {
    loadColumns(this.value);
  } else {
    columnSelect.innerHTML = '<option value="">-- Choisir d\'abord une table --</option>';
    columnSelect.disabled = true;
    generateBtn.disabled = true;
    resultDiv.innerHTML = '';
  }
});

columnSelect.addEventListener('change', function() {
  generateBtn.disabled = !this.value;
  resultDiv.innerHTML = '';
  currentUrl = null;
});

$('urlForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const table  = tableSelect.value;
  const column = columnSelect.value;
  if (!table || !column || !docId) return;

  setLoading(generateBtn, true);
  resultDiv.innerHTML = '';

  try {
    const url = generateFilterUrl(docId, table, column);
    showResult(url, table, column);
  } catch (err) {
    resultDiv.innerHTML = `<div class="alert alert--error">âŒ Erreur : ${err.message}</div>`;
  }

  setLoading(generateBtn, false, 'GÃ©nÃ©rer l\'URL');
  generateBtn.disabled = false;
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INITIALISATION GRIST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grist.ready({
  requiredAccess: 'full',
  onEditOptions: undefined
});

// RÃ©cupÃ©ration du docId depuis l'URL Grist (window.location)
function extractDocIdFromUrl() {
  const match = window.location.href.match(/\/docs\/([^/]+)/);
  return match ? match[1] : null;
}

// grist.ready() â†’ ensuite on charge les tables
// On utilise onOptions pour dÃ©tecter que Grist a bien chargÃ© le widget
grist.onOptions(async (opts, interaction) => {
  await initWidget();
});

// Fallback si onOptions ne se dÃ©clenche pas
setTimeout(async () => {
  if (!docId) await initWidget();
}, 1500);

async function initWidget() {
  if (docId) return;

  try {
    const tokenInfo = await grist.docApi.getAccessToken({ readOnly: true });

    // Affichage debug brut
    let debugHtml = '<div style="background:#fff3cd;padding:1rem;font-family:monospace;font-size:0.75rem;word-break:break-all;margin-bottom:1rem;">';
    debugHtml += '<b>DEBUG getAccessToken</b><br><br>';
    debugHtml += `<b>baseUrl :</b> ${tokenInfo.baseUrl}<br><br>`;

    let payload = {};
    try {
      payload = JSON.parse(atob(tokenInfo.token.split('.')[1]));
      debugHtml += `<b>JWT payload :</b><br>${JSON.stringify(payload, null, 2).replace(/\n/g,'<br>').replace(/ /g,'&nbsp;')}`;
    } catch(e) {
      debugHtml += `<b>JWT decode error :</b> ${e.message}`;
    }
    debugHtml += '</div>';
    resultDiv.innerHTML = debugHtml;

    // Tentatives extraction docId
    docId = payload.docId || payload.doc || payload.d || null;
    if (!docId) {
      const m = tokenInfo.baseUrl.match(/\/docs\/([^/]+)/);
      if (m) docId = m[1];
    }
    if (!docId) {
      const m2 = tokenInfo.baseUrl.match(/\/([a-zA-Z0-9]{20,})/);
      if (m2) docId = m2[1];
    }

    resultDiv.innerHTML += `<div style="background:#d4edda;padding:0.5rem;font-family:monospace;font-size:0.8rem;">docId extrait : <b>${docId || 'NON TROUVÃ‰'}</b></div>`;

    if (!docId) {
      setStatus('error', 'Impossible de dÃ©tecter l\'ID du document');
      return;
    }

    await loadTables();

  } catch(err) {
    resultDiv.innerHTML = `<div style="background:#f8d7da;padding:1rem;font-family:monospace;font-size:0.75rem;">ERREUR : ${err.message}</div>`;
    setStatus('error', `Erreur : ${err.message}`);
  }
}

</script>

</body>
</html>
